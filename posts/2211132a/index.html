<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;default&quot;]"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="alternate" href="/rss.xml" title="烂笔头" type="application/rss+xml"><link rel="alternate" href="/atom.xml" title="烂笔头" type="application/atom+xml"><link rel="alternate" type="application/json" title="烂笔头" href="https://linsanzhu.github.io/feed.json"/><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"/><link rel="preconnect" href="https://at.alicdn.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CMa%20Shan%20Zheng,Noto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Sans%20Simplified%20Chinese,Noto%20Sans%20Traditional%20Chinese:400,400italic,700,700italic%7CSource%20Code%20Pro,Noto%20Sans%20Simplified%20Chinese:400,400italic,700,700italic&display=swap&subset=latin,latin-ext" media="none" onload="this.media&#x3D;&#39;all&#39;"><link rel="stylesheet" href="/css/app.css?v=0.4.2"><link rel="modulepreload" href="/js/chunk-2YXICMYP.js"></link><link rel="modulepreload" href="/js/chunk-7CEZKU5F.js"></link><link rel="modulepreload" href="/js/chunk-ETYUGVIS.js"></link><link rel="modulepreload" href="/js/chunk-LYME6JKK.js"></link><link rel="modulepreload" href="/js/chunk-YF3OF5AX.js"></link><link rel="modulepreload" href="/js/comments-X2PGRW3X.js"></link><link rel="modulepreload" href="/js/index.esm-NGF4BI5A.js"></link><link rel="modulepreload" href="/js/post-L2T3HVOQ.js"></link><link rel="modulepreload" href="/js/quicklink-3ZU43OGZ.js"></link><link rel="modulepreload" href="/js/search-N7MSBNH2.js"></link><link rel="modulepreload" href="/js/siteInit.js"></link><link rel="stylesheet" href="https://npm.webcache.cn/@waline/client@3.0.0-alpha.11/dist/waline.css" media="none" onload="this.media='all'"/><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?712556" as="image" fetchpriority="high"><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?143617" as="image" fetchpriority="high"><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?683750" as="image" fetchpriority="high"><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?491897" as="image" fetchpriority="high"><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?158291" as="image" fetchpriority="high"><link rel="preload" href="https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?949424" as="image" fetchpriority="high"><meta name="description" content="面试常见问题要点汇总"/><link rel="canonical" href="https://linsanzhu.github.io/posts/2211132a/"><title>面试知识总结</title><meta name="robots" content="noindex"><meta name="generator" content="Hexo 7.2.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">面试知识总结</h1><div class="meta"><span class="item" title="创建时间：2024-06-19 22:44:50"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-06-19T22:44:50+08:00">2024-06-19</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>11k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>10 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Linsan Zhu's Blog</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?712556&quot;);"></li><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?143617&quot;);"></li><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?683750&quot;);"></li><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?491897&quot;);"></li><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?158291&quot;);"></li><li class="item" style="background-image: url(&quot;https://acg.xydwz.cn/api/api.php,https://api.miaomc.cn/image/get?949424&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/">首页</a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://linsanzhu.github.io/posts/2211132a/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/assets/avatar.png"/><meta itemprop="name" content="Linsan Zhu"/><meta itemprop="description" content="If it feels easy, don't do it. Don't let the world spoil you., LinsanZhu's Blog"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="烂笔头"/></span><div class="body md" itemprop="articleBody"><h1 id="redis"><a class="markdownIt-Anchor" href="#redis"></a> Redis</h1>
<h2 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型"></a> 数据类型</h2>
<ul>
<li><strong>String</strong>: sds</li>
<li><strong>List</strong>:
<ul>
<li>3.2前:
<ul>
<li>元素数量少于512，每个元素小于64字节，使用ziplist</li>
<li>否则使用双向链表</li>
</ul>
</li>
<li>3.2后:
<ul>
<li>使用quicklist</li>
<li>双向链表的节点是ziplist</li>
</ul>
</li>
</ul>
</li>
<li><strong>Set</strong>：
<ul>
<li>元素个数小于512，且都是整数，用整数集合</li>
<li>否则用hashmap</li>
</ul>
</li>
<li><strong>ZSet</strong>：
<ul>
<li>元素个数小于128，且每个元素小于64字节，用ziplist</li>
<li>否则用skiplist</li>
</ul>
</li>
<li><strong>Hash</strong>：
<ul>
<li>元素个数小于512，且每个值小于64字节，使用ziplist</li>
<li>否则用hashmap</li>
<li>7.0开始废弃ziplist，改用listpack</li>
</ul>
</li>
<li><strong>BitMap</strong>：</li>
<li><strong>HyperLogLog</strong>：</li>
<li><strong>Geo</strong>：</li>
<li><strong>Stream</strong>：</li>
</ul>
<h2 id="数据结构"><a class="markdownIt-Anchor" href="#数据结构"></a> 数据结构</h2>
<ul>
<li><strong>list</strong>:
<ul>
<li>缺陷：无法利用cpu缓存</li>
</ul>
</li>
<li><strong>ziplist</strong>:
<ul>
<li>缺陷：连锁更新</li>
</ul>
</li>
<li><strong>hash</strong>:
<ul>
<li>链式哈希解决冲突</li>
<li>双hash、动态扩容</li>
</ul>
</li>
<li><strong>Skiplist</strong>:
<ul>
<li>创建节点时，生成0-1的随机数，如果小于0.25，+1层，继续生成，直到层数达到层高限制或者大于0.25</li>
<li>比平衡树<strong>实现简单，更紧凑，占用空间小，支持范围遍历</strong></li>
</ul>
</li>
<li><strong>quicklist</strong>:</li>
<li><strong>listpack</strong>:
<ul>
<li>解决了ziplist连锁更新问题</li>
</ul>
</li>
</ul>
<h2 id="持久化"><a class="markdownIt-Anchor" href="#持久化"></a> 持久化</h2>
<h3 id="aof记录写操作命令"><a class="markdownIt-Anchor" href="#aof记录写操作命令"></a> AOF：记录写操作命令</h3>
<ul>
<li><strong>写回策略</strong>：
<ul>
<li>always：所有命令立即fsync到磁盘
<ul>
<li>数据丢失最少，性能最差</li>
</ul>
</li>
<li>everysec：每秒fsync到磁盘</li>
<li>no：由系统控制写回时机
<ul>
<li>数据丢失最多，性能好</li>
</ul>
</li>
</ul>
</li>
<li><strong>重写机制</strong>：
<ul>
<li><strong>后台重写</strong>：
<ul>
<li>数据大时，fork复制页表会阻塞主进程</li>
<li>Cow时会阻塞主进程</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="rdb内存快照"><a class="markdownIt-Anchor" href="#rdb内存快照"></a> RDB：内存快照</h3>
<ul>
<li>执行save或bgsave</li>
<li>Bgsave会创建子进程</li>
</ul>
<h2 id="过期策略"><a class="markdownIt-Anchor" href="#过期策略"></a> 过期策略：</h2>
<ul>
<li><strong>定期 + 惰性</strong>
<ul>
<li>定期频率：默认10 HZ，随机抽取20个key，如果过期率超过25%，则继续抽取，最长25ms</li>
</ul>
</li>
</ul>
<h2 id="淘汰策略"><a class="markdownIt-Anchor" href="#淘汰策略"></a> 淘汰策略：</h2>
<blockquote>
<p><strong>3.0默认不淘汰</strong>，内存超过阈值后，不接受新key写入，只能读<br />
LRU： 随机抽5个key，淘汰最久未使用的<br />
LFU： 24bit分为 16bit时间戳 + 8bit 使用频率</p>
</blockquote>
<ul>
<li>
<p><strong>过期key里淘汰</strong></p>
<ul>
<li>random</li>
<li>ttl： 淘汰最早过期</li>
<li>lru</li>
<li>lfu</li>
</ul>
</li>
<li>
<p><strong>所有数据里淘汰</strong></p>
<ul>
<li>random</li>
<li>lru</li>
<li>lfu</li>
</ul>
</li>
</ul>
<h2 id="高可用"><a class="markdownIt-Anchor" href="#高可用"></a> 高可用</h2>
<ul>
<li>
<p><strong>主从</strong>： 读写分离</p>
<ul>
<li>数据同步：
<ul>
<li>从节点第一次同步全量同步：
<ol>
<li>主进程fork子进程，执行bgsave生成RDB，传输RDB且从节点，从节点收到RDB后清空数据，载入RDB</li>
<li>从节点同步数据期间，主节点记录所有更新命令到 replication buffer</li>
<li>主节点收到从节点确认消息后，发送 replication buffer中的命令给从节点</li>
</ol>
</li>
<li>第一次同步完成后，主从之间保持长链接，进行后续命令同步：
<ul>
<li>主节点维护repl_backlog_buffer和replication offset：
<ul>
<li>repl_backlog_buffer: 环形缓冲区</li>
<li>replication offset表示当前同步进度：
<ul>
<li>master_repl_offset：主节点写进度</li>
<li>slave_repl_offset：从节点读进度</li>
</ul>
</li>
</ul>
</li>
<li>如果主从同步出现断连，重连后：
<ul>
<li>如果从节点为同步命令还在repl_backlog_buffer,采用增量同步</li>
<li>否则重新开始全量同步</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>过期key处理：主节点模拟del命令发给从节点</li>
<li>主从切换数据丢失：
<ul>
<li><strong>异步复制</strong>：同步给从节点前，主节点下线，导致数据丢失</li>
<li><strong>脑裂</strong>：主节点和client网络正常，但是和从节点网络异常，导致哨兵选举新的主节点
<ul>
<li>min-slaves-to-write x：至少x个从节点连接，少于x主节点拒绝写入</li>
<li>min-slaves-max-lag x：主从同步延迟应低于x秒，否则拒绝写入</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>哨兵</strong>：</p>
<ul>
<li>
<p>判断主节点故障：</p>
<ul>
<li>主观下线：每秒心跳检测，如果没有在规定时间返回，标记为主观下线</li>
<li>客观下线：询问其他哨兵对主关下线的机器投票，如果确认下线的票数超过quorum（一般哨兵数的一半+1），标记为客观下线，开始执行故障转移</li>
</ul>
</li>
<li>
<p>选举故障转移执行人：识别出主节点客观下线的哨兵作为候补leader，与其他哨兵互相投票，每个哨兵只有一票，候补哨兵投给自己，赞成票达到quorum的作为leader执行故障转移</p>
</li>
<li>
<p>故障转移：</p>
<ul>
<li>根据从节点优先级、复制进度、id排序，选取新主节点</li>
<li>哨兵发送slaveof命令给其他从节点修改主节点</li>
<li>哨兵通过发布订阅模式通知新主节点ip给client</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="数据一致性"><a class="markdownIt-Anchor" href="#数据一致性"></a> 数据一致性</h2>
<ul>
<li>
<p><strong>旁路缓存</strong>：更新时删除缓存，读取时写入缓存</p>
</li>
<li>
<p><strong>雪崩</strong>：大量key同时过期</p>
<ul>
<li>均匀过期时间，随机数</li>
<li>互斥锁，保证同时只有一个请求查询数据库，singleflight</li>
<li>后台更新
<ul>
<li>缓存不过期，后台异步定期更新缓存
<ul>
<li>有数据淘汰风险，</li>
<li>更新有延迟</li>
</ul>
</li>
<li>消息队列：
<ul>
<li>有延迟</li>
</ul>
</li>
</ul>
</li>
<li>熔断：直接返回错误，有业务损失</li>
<li>限流：只放过部分请求，业务损失可接受</li>
<li>主从、cluster</li>
</ul>
</li>
<li>
<p><strong>击穿</strong>：热点key过期</p>
<ul>
<li>
<p>互斥锁</p>
</li>
<li>
<p>异步更新</p>
</li>
</ul>
</li>
<li>
<p><strong>穿透</strong>：大量请求查询不存在的key</p>
<ul>
<li>
<p>请求校验， 过滤明显异常请求</p>
</li>
<li>
<p>构造空key</p>
</li>
<li>
<p>布隆过滤器</p>
</li>
</ul>
</li>
</ul>
<h2 id="应用"><a class="markdownIt-Anchor" href="#应用"></a> 应用</h2>
<ul>
<li>
<p>点赞： set</p>
</li>
<li>
<p>网站uv： hyperloglog</p>
</li>
<li>
<p>共同关注： set</p>
</li>
<li>
<p>排行榜： zset</p>
</li>
<li>
<p>购物车： hash</p>
</li>
<li>
<p>队列： stream</p>
</li>
<li>
<p>分布式锁： string</p>
</li>
<li>
<p>全局唯一id生成： string</p>
</li>
<li>
<p>抽奖： set</p>
</li>
<li>
<p>签到： bitmap</p>
</li>
<li>
<p>布隆过滤器： bitmap</p>
</li>
</ul>
<h1 id="系统"><a class="markdownIt-Anchor" href="#系统"></a> 系统</h1>
<h2 id="进程调度算法"><a class="markdownIt-Anchor" href="#进程调度算法"></a> 进程调度算法</h2>
<ul>
<li>
<p><strong>FIFO</strong>: 先来先服务</p>
</li>
<li>
<p><strong>最短任务优先</strong>：短任务多时会导致长任务饥饿</p>
</li>
<li>
<p><strong>高响应比</strong>：理想算法，没法实用 （等待时间+预计执行时间）/预计执行时间</p>
</li>
<li>
<p><strong>高优先级优先</strong>：会导致低优先级任务饥饿</p>
</li>
<li>
<p><strong>时间片轮转</strong>：长任务会被频繁打断， 频率越高，效率越差，频率越低，资源浪费越严重</p>
</li>
<li>
<p><strong>多级反馈队列</strong>：设定多个不同时间片队列，初始任务都在最短时间片队列，如果没执行完移到下一级队列，且每一级队列等候时间不同，时间片越长，等候时间越长，且如果短队列有任务，可以打断长任务执行</p>
</li>
</ul>
<h2 id="内存页面置换"><a class="markdownIt-Anchor" href="#内存页面置换"></a> 内存页面置换</h2>
<ul>
<li>
<p><strong>FIFO</strong>：先进先出</p>
</li>
<li>
<p><strong>LRU</strong>：有缓存污染和预读失效问题，且管理列表资源损耗大， linux采用两级队列解决，初始放入old队列队头，真正使用时放入young队列队头，并把young队列最久没使用的页放入old队列队头</p>
</li>
<li>
<p><strong>LFU</strong>：维护频次成本高，查找效率低，刚开始频繁访问但次数不高的页面会被误伤</p>
</li>
</ul>
<h2 id="锁"><a class="markdownIt-Anchor" href="#锁"></a> 锁</h2>
<ul>
<li>
<p><strong>悲观锁</strong>：适用多线程同时修改资源概率高的场景</p>
</li>
<li>
<p><strong>互斥锁</strong>：加锁失败需要两次线程上下文切换（线程睡眠换出，睡眠中的线程换入）</p>
</li>
<li>
<p><strong>自旋锁</strong>：忙等，适合执行时间短</p>
</li>
<li>
<p><strong>读写锁</strong>：适用能明确区分读写的场景， 分读优先和写优先、公平（fifo）</p>
</li>
<li>
<p><strong>乐观锁</strong>：基于CAS，适用多线程同时修改资源概率低的场景</p>
</li>
</ul>
<h3 id="死锁"><a class="markdownIt-Anchor" href="#死锁"></a> 死锁：</h3>
<ul>
<li>四个条件： <strong>互斥、持有等待、不可剥夺、循环依赖</strong></li>
</ul>
<h2 id="进程通信方式"><a class="markdownIt-Anchor" href="#进程通信方式"></a> 进程通信方式</h2>
<ul>
<li>
<p><strong>管道</strong>：匿名管道、具名管道，单向通信， 系统调用：pipe，匿名管道只能父子进程通信，命名管道可以不相关进程通信</p>
</li>
<li>
<p><strong>共享内存</strong>：把一块虚拟地址映射到同一块物理地址</p>
</li>
<li>
<p><strong>消息队列</strong>：通信不及时，附件有大小限制，存在用户态和内核态数据拷贝</p>
</li>
<li>
<p><strong>信号量</strong>：可携带数据更少，支持P（-） V(+)操作，主要用于进程同步</p>
</li>
<li>
<p><strong>信号</strong>： kill -9</p>
</li>
<li>
<p><strong>socket</strong>：</p>
</li>
</ul>
<h2 id="io类型"><a class="markdownIt-Anchor" href="#io类型"></a> IO类型</h2>
<ul>
<li>
<p><strong>BIO</strong>： 同步阻塞，一直等待，直到数据可读</p>
</li>
<li>
<p><strong>NIO</strong>： 同步非阻塞，数据不可读时直接返回错误，循环尝试，直到数据可读</p>
</li>
<li>
<p><strong>多路复用</strong>： 仍属于同步io</p>
<ul>
<li><strong>Select</strong>： 需要频繁在用户态和内核态做数据拷贝，数组形式维护，有长度限制，需要遍历数组发现可读状态</li>
<li><strong>Poll</strong>： 链表形式维护，没有长度限制，但依然需要遍历及用户态内核态拷贝</li>
<li><strong>Epoll</strong>： 内核用红黑树维护文件描述符，只需要拷贝给定的文件描述符，基于事件机制， 分为</li>
<li><strong>水平触发</strong>：只要还有数据可读，就触发</li>
<li><strong>边缘触发</strong>：只触发一次</li>
<li>Reactor：基于多路复用，redis是多reactor，单线程模型，</li>
</ul>
</li>
<li>
<p><strong>AIO</strong>：异步IO，应用把需要读取的文件描述符和读取到的目标位置给内核，由内核读取完成后，通知应用</p>
</li>
</ul>
<h2 id="零拷贝"><a class="markdownIt-Anchor" href="#零拷贝"></a> 零拷贝</h2>
<ul>
<li>
<p>mmap + write： 磁盘-&gt;内核缓冲区 -&gt; mmap到用户空间 -&gt; 用户write到sokect缓冲区-&gt;网卡</p>
</li>
<li>
<p>linux 2.1 提供sendfile系统调用： 磁盘-&gt;内核缓冲区 -&gt; sokect缓冲区 -&gt; 网卡</p>
</li>
<li>
<p>Linux 2.4 利用sg-dma 完成内核缓冲区-&gt;网卡的copy，不需要cpu参与</p>
</li>
</ul>
<h1 id="mysql"><a class="markdownIt-Anchor" href="#mysql"></a> MySQL</h1>
<h2 id="事务"><a class="markdownIt-Anchor" href="#事务"></a> 事务</h2>
<h3 id="特性"><a class="markdownIt-Anchor" href="#特性"></a> 特性：</h3>
<ul>
<li><strong>原子性</strong>： 要么都成功，要么都不成功， 通过undolog保证</li>
<li><strong>一致性</strong>： 事务前后数据满足完整性约束，</li>
<li><strong>持久性</strong>： 事务结束后，数据变化是永久有效的，通过redolog实现</li>
<li><strong>隔离性</strong>： 事务之间不能互相影响，通过mvcc + 锁保证</li>
</ul>
<h3 id="隔离级别"><a class="markdownIt-Anchor" href="#隔离级别"></a> 隔离级别：</h3>
<ul>
<li><strong>读未提交</strong>：有脏读问题</li>
<li><strong>读已提交</strong>： 不可重复读，有幻读问题</li>
<li><strong>可重复读</strong>： 默认隔离级别，有幻读问题，但通过mvcc+间隙锁，一定程度上解决了幻读</li>
<li><strong>串行化</strong>： 性能差，一般不用</li>
</ul>
<blockquote>
<ul>
<li><strong>脏读</strong>： 事务读取到别的未完成事务修改的数据</li>
<li><strong>不可重复度</strong>： 前后两次读取数据不一致</li>
<li><strong>幻读</strong>： 读取到其他事务删除或添加的数据</li>
</ul>
</blockquote>
<h3 id="mvcc"><a class="markdownIt-Anchor" href="#mvcc"></a> MVCC:</h3>
<ul>
<li>ReadView:
<ul>
<li>creator_trx_id：创建ReadView的事务id</li>
<li>m_ids：创建Readview时活跃未提交事务id列表</li>
<li>min_trx_Id：创建ReadView时活跃事务中最小的事务id</li>
<li>max_trx_id：创建ReadView时应该分配的下一事务id</li>
</ul>
</li>
<li>聚簇索引记录中的隐藏列：
<ul>
<li>trx_id：最后修改的事务id</li>
<li>roll_pointer： undolog链表</li>
</ul>
</li>
<li>事务访问记录分三种情况：
<ol>
<li>聚簇索引trx_id小于min_trx_id：说明在当前事务之前创建，可见</li>
<li>聚簇索引trx_id 大于等于min_trx_id，小于max_trx_id：
<ul>
<li>在m_ids里：生成该记录的事务未完成，不可见</li>
<li>不在m_ids里：生成该记录的事务已完成，可见</li>
</ul>
</li>
<li>聚簇索引trx_id &gt;= max_trx_id：在当前事务之后创建，不可见
<ul>
<li>读提交和可重复度差异：</li>
</ul>
</li>
</ol>
</li>
<li>读已提交： ReadView在每次读时新建</li>
<li>可重复度：在事务开始时创建ReadView</li>
</ul>
<h2 id="锁-2"><a class="markdownIt-Anchor" href="#锁-2"></a> 锁</h2>
<ul>
<li>
<p><strong>全局锁</strong></p>
<pre class="highlight"><code class="sql">flush tables <span class="hljs-keyword">with</span> read lock
unlock tables
</code></pre>
<ul>
<li>
<p>用于全库逻辑备份</p>
</li>
<li>
<p>所有修改操作被阻塞</p>
</li>
</ul>
</li>
<li>
<p><strong>表级锁</strong></p>
<ul>
<li>
<p>表锁：与行锁冲突</p>
<ul>
<li>
<pre class="highlight"><code class="sql">lock tables _table read;
lock tables _table write;
</code></pre>
</li>
</ul>
</li>
<li>
<p>元数据锁：</p>
<ul>
<li>
<p>修改表结构自动加写锁</p>
</li>
<li>
<p>防止CRUD时表结构变更</p>
</li>
<li>
<p>CRUD自动加读锁</p>
</li>
</ul>
</li>
<li>
<p>意向锁：</p>
<ul>
<li>
<p>意向锁之间不冲突</p>
</li>
<li>
<p>与表锁冲突，用于避免加表锁时遍历所有记录</p>
</li>
<li>
<p>与行锁兼容</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>行锁</strong></p>
<blockquote>
<p>加锁对象是<strong>索引项</strong></p>
</blockquote>
<ul>
<li>
<p><strong>记录锁</strong>：</p>
</li>
<li>
<p><strong>间隙锁</strong>：用于防止一个事务没完成，别的事务在间隙插入/删除数据</p>
<ul>
<li>间隙锁之间兼容，多个事务可以获取同一间隙范围的锁</li>
</ul>
</li>
<li>
<p><strong>Next-Key</strong>：记录锁+间隙锁，左开右闭</p>
<ul>
<li>
<p>如果右侧记录不存在，退化成间隙锁</p>
</li>
<li>
<p>需考虑记录锁间的冲突</p>
</li>
</ul>
</li>
<li>
<p><strong>插入意向锁</strong>：属于记录锁，多事务相斥，与间隙锁相斥</p>
<ul>
<li>事务插入记录时，需要判断是否有间隙锁，有的话生成插入意向锁</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="存储"><a class="markdownIt-Anchor" href="#存储"></a> 存储</h2>
<h3 id="行结构"><a class="markdownIt-Anchor" href="#行结构"></a> 行结构</h3>
<ul>
<li>
<p>Compact: 5.1后默认行格式</p>
<table>
<thead>
<tr>
<th>变长字段列表</th>
<th>NULL值列表</th>
<th>记录头</th>
<th>row_id</th>
<th>trx_id</th>
<th>roll_ptr</th>
<th>列1</th>
<th>列2</th>
<th>列3</th>
</tr>
</thead>
</table>
</li>
<li>
<p>Dynamic：5.7后默认</p>
</li>
</ul>
<h3 id="单表数量限制计算"><a class="markdownIt-Anchor" href="#单表数量限制计算"></a> 单表数量限制计算</h3>
<ul>
<li>
<p>索引行：长度12字节</p>
<ul>
<li>页中最小记录id + 页号地址</li>
</ul>
</li>
<li>
<p>单页总共16k，15k可用</p>
</li>
<li>
<p>3层b+tree,单记录1k算，能容纳</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mfrac><mrow><mn>15</mn><mo>∗</mo><mn>1024</mn></mrow><mn>12</mn></mfrac><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>∗</mo><mn>15</mn><mo>=</mo><mn>128</mn><msup><mn>0</mn><mn>2</mn></msup><mo>∗</mo><mn>15</mn><mo>=</mo><mn>24576000</mn></mrow><annotation encoding="application/x-tex">(\frac{15*1024}{12})^2 * 15 = 1280^2 * 15 = 24576000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span><span class="mbin mtight">∗</span><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">4</span><span class="mord">5</span><span class="mord">7</span><span class="mord">6</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span></span></span></span></li>
</ul>
</li>
</ul>
<h2 id="索引"><a class="markdownIt-Anchor" href="#索引"></a> 索引</h2>
<h3 id="分类"><a class="markdownIt-Anchor" href="#分类"></a> 分类</h3>
<ul>
<li>
<p><strong>按数据结构</strong></p>
<ul>
<li>
<p>B+Tree</p>
</li>
<li>
<p>Hash</p>
</li>
<li>
<p>Full-text</p>
</li>
</ul>
</li>
<li>
<p><strong>按物理存储</strong></p>
<ul>
<li>
<p>聚簇索引</p>
</li>
<li>
<p>非聚簇索引</p>
</li>
</ul>
</li>
<li>
<p><strong>按字段特性</strong></p>
<ul>
<li>
<p>主建索引</p>
</li>
<li>
<p>唯一索引</p>
</li>
<li>
<p>普通索引</p>
</li>
<li>
<p>前缀索引</p>
</li>
</ul>
</li>
<li>
<p><strong>按字段个数</strong></p>
<ul>
<li>
<p>单列索引</p>
</li>
<li>
<p>联合索引</p>
</li>
</ul>
</li>
</ul>
<h3 id="索引失效"><a class="markdownIt-Anchor" href="#索引失效"></a> 索引失效</h3>
<ul>
<li>
<p>对索引使用函数、表达式计算</p>
</li>
<li>
<p>对索引隐式类型转换，入 str -&gt; int</p>
</li>
<li>
<p>联合索引非最左匹配</p>
</li>
</ul>
<h2 id="分库分表"><a class="markdownIt-Anchor" href="#分库分表"></a> 分库分表</h2>
<ul>
<li>
<p><strong>垂直分表</strong>：一般按业务拆分</p>
</li>
<li>
<p><strong>水平分表</strong>：需要考虑全局唯一key</p>
<ul>
<li>
<p>雪花算法：趋势递增，强依赖机器时钟</p>
</li>
<li>
<p>叶子算法：</p>
<ul>
<li>
<p>Leaf-segment: proxy批量获取号段，减少访问数据库次数</p>
</li>
<li>
<p>Leaf-snowflake：基于雪花算法</p>
</li>
</ul>
</li>
<li>
<p>uuid：不易存储，占用空间大，不利于索引</p>
</li>
<li>
<p>自增：需要发号服务</p>
<ul>
<li>
<p>固定步长+不同起始偏移：水平扩展困难</p>
</li>
<li>
<p>号段：</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="网络"><a class="markdownIt-Anchor" href="#网络"></a> 网络</h1>
<h2 id="tcpip模型"><a class="markdownIt-Anchor" href="#tcpip模型"></a> Tcp/IP模型</h2>
<h3 id="1-应用层"><a class="markdownIt-Anchor" href="#1-应用层"></a> 1. 应用层</h3>
<h4 id="http"><a class="markdownIt-Anchor" href="#http"></a> HTTP</h4>
<h5 id="http-11"><a class="markdownIt-Anchor" href="#http-11"></a> HTTP 1.1</h5>
<ul>
<li>
<p>长链接、管道：有队头堵塞问题，服务端必须按照请求顺序返回</p>
</li>
<li>
<p>缺陷：</p>
<ul>
<li>
<p>请求/响应头没压缩，资源浪费</p>
</li>
<li>
<p>只能client发起请求</p>
</li>
<li>
<p>队头阻塞</p>
</li>
</ul>
</li>
</ul>
<h5 id="http-2"><a class="markdownIt-Anchor" href="#http-2"></a> HTTP 2</h5>
<ul>
<li>
<p>基于https，安全</p>
</li>
<li>
<p>header压缩</p>
</li>
<li>
<p>二进制传输</p>
<ul>
<li>
<p>header frame</p>
</li>
<li>
<p>data frame</p>
</li>
</ul>
</li>
<li>
<p>Stream：每个请求分配streamid，可时分复用连接，双向</p>
</li>
<li>
<p>基于tcp实现，由于tcp的顺序性，也有队头堵塞问题</p>
</li>
</ul>
<h5 id="http-3"><a class="markdownIt-Anchor" href="#http-3"></a> HTTP 3</h5>
<ul>
<li>
<p>基于UDP</p>
<ul>
<li>用QUIC协议保证可靠性</li>
</ul>
</li>
</ul>
<h4 id="https"><a class="markdownIt-Anchor" href="#https"></a> HTTPS</h4>
<ol>
<li>
<p>client发起请求，生成随机数 random1，以及支持的算法，ssl版本</p>
</li>
<li>
<p>server收到请求后，校验ssl版本， 生成随机数random2，用自己的私钥加密，和证书一起发给client</p>
</li>
<li>
<p>client收到响应后，校验证书有效性，如果有效，则从证书里取出服务端公钥，生成随机数random3，用公钥加密，传给server</p>
</li>
<li>
<p>此时client和服务端都有了random2，random3，可以生成同样的对称加密私钥，后续通信都用私钥加密；服务端需要返回确认通知，包含之前信息的摘要，供client校验</p>
</li>
</ol>
<h5 id="建立连接过程"><a class="markdownIt-Anchor" href="#建立连接过程"></a> 建立连接过程</h5>
<h3 id="2-传输层"><a class="markdownIt-Anchor" href="#2-传输层"></a> 2. 传输层</h3>
<h4 id="tcp"><a class="markdownIt-Anchor" href="#tcp"></a> TCP</h4>
<h5 id="三次握手"><a class="markdownIt-Anchor" href="#三次握手"></a> 三次握手</h5>
<ul>
<li>
<p>server没调用listen时，client调用connect会收到server返回的RST包</p>
</li>
<li>
<p>对端没有调用listen也可以建立连接，要求</p>
<ul>
<li>
<p>对端同时通过connect连接当前机器</p>
</li>
<li>
<p>或者client connect自己</p>
</li>
</ul>
</li>
</ul>
<h5 id="四次挥手"><a class="markdownIt-Anchor" href="#四次挥手"></a> 四次挥手</h5>
<ul>
<li>
<p>MSL在linux里固定为30秒</p>
</li>
<li>
<p>Timewait状态优化</p>
<ol>
<li>
<p>tcp_max_tw_buckets表示最多可以有多少个连接处于Timewait状态，超过时直接关闭连接</p>
</li>
<li>
<p>tcp_tw_reuse表示建立连接时（调用connect()）可以重用Timewait状态的连接，只能用于client</p>
<ul>
<li>
<p>跳过Timewait状态，可能收到历史RST包，由于RST包优于时间戳校验，会导致连接直接断开</p>
</li>
<li>
<p>跳过Timewait状态，可能导致被动连接方在没收到第四次ack包而重传fin包后，收到client的RST包，从而异常退出</p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h5 id="重传机制"><a class="markdownIt-Anchor" href="#重传机制"></a> 重传机制</h5>
<h6 id="超时重传"><a class="markdownIt-Anchor" href="#超时重传"></a> 超时重传</h6>
<ul>
<li>
<p>定时器，超时未收到ack，开始重传</p>
</li>
<li>
<p>超时时间RTO要比RTT略大</p>
</li>
</ul>
<h6 id="快速重传"><a class="markdownIt-Anchor" href="#快速重传"></a> 快速重传</h6>
<ul>
<li>
<p>收到3个相同ack，可确认包丢失，立即重传</p>
</li>
<li>
<p>无法确认重传一个包，还是重传所有包</p>
</li>
<li>
<h6 id="sack"><a class="markdownIt-Anchor" href="#sack"></a> <strong>SACK</strong></h6>
<ul>
<li>在TCP选项里添加已接收包的信息</li>
</ul>
</li>
</ul>
<h5 id="流量控制"><a class="markdownIt-Anchor" href="#流量控制"></a> 流量控制</h5>
<ul>
<li>
<h6 id="滑动窗口"><a class="markdownIt-Anchor" href="#滑动窗口"></a> 滑动窗口</h6>
<table>
<thead>
<tr>
<th>已确认数据</th>
<th>已发送未ack</th>
<th>待发送对方可接收</th>
<th>未发送超出对方接收窗口</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th>已接收并ack</th>
<th>未接收但可以接收（接收窗口）</th>
<th>不能接收</th>
</tr>
</thead>
</table>
<p>窗口减少到0时，开启定时器，开始发送窗口探测报文</p>
<ul>
<li>一般探测3次，大约30-60秒每次，如果3次后窗口还是0，有可能发送RST断开链接</li>
</ul>
</li>
</ul>
<h5 id="拥塞控制"><a class="markdownIt-Anchor" href="#拥塞控制"></a> 拥塞控制</h5>
<blockquote>
<p>cwnd：拥塞窗口，ssthresh：拥塞避免门限</p>
</blockquote>
<h6 id="慢启动"><a class="markdownIt-Anchor" href="#慢启动"></a> 慢启动</h6>
<ul>
<li>每收到一个ack，拥塞窗口cwnd+1（等于每次翻倍）</li>
</ul>
<h6 id="拥塞避免"><a class="markdownIt-Anchor" href="#拥塞避免"></a> 拥塞避免</h6>
<ul>
<li>
<p>cwnd涨到ssthresh后，开始线性增长</p>
<ul>
<li>每收到一个ack，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>w</mi><mi>n</mi><mi>d</mi><mo>+</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mi>c</mi><mi>w</mi><mi>n</mi><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">cwnd += \frac{1}{cwnd}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord">+</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></li>
</ul>
</li>
<li>
<p>一般ssthresh=65535</p>
</li>
</ul>
<h6 id="拥塞发生"><a class="markdownIt-Anchor" href="#拥塞发生"></a> 拥塞发生</h6>
<ul>
<li>
<p>发生超时重传后</p>
<ul>
<li>
<p>ssthresh设为cwnd/2</p>
</li>
<li>
<p>cwnd设为1，重新开始慢启动</p>
</li>
</ul>
</li>
<li>
<p>发生快速重传后</p>
<ol>
<li>
<p>ssthresh = cwnd / 2</p>
</li>
<li>
<p>开始快速恢复</p>
</li>
</ol>
</li>
</ul>
<h6 id="快速恢复"><a class="markdownIt-Anchor" href="#快速恢复"></a> 快速恢复</h6>
<ol>
<li>
<p>cwnd = ssthresh + 3</p>
<ul>
<li>此时ssthresh = 拥塞发生时cwnd的一半</li>
<li>3 表示快速重传收到的3个重复ack</li>
</ul>
</li>
<li>
<p>每收到一个重复ack，cwnd+1</p>
<ul>
<li>主要为了快速把丢失的包发给目标</li>
</ul>
</li>
<li>
<p>直到收到新的ack，恢复过程结束，把cwnd设置为ssthresh，重新开始拥塞避免</p>
</li>
</ol>
<h5 id="半连接-全连接队列"><a class="markdownIt-Anchor" href="#半连接-全连接队列"></a> 半连接、全连接队列</h5>
<ul>
<li>
<p><strong>半连接队列（SYN队列）</strong>：</p>
<ul>
<li>
<p>server收到client的connect syn包后，把连接放到半连接队列里</p>
</li>
<li>
<p>通过增大somaxconn和backlog可以增大半连接队列</p>
</li>
</ul>
</li>
<li>
<p><strong>全连接队列</strong></p>
<ul>
<li>
<p>server收到client的ACK包后，把连接放入全连接队列</p>
</li>
<li>
<p>accept()从全连接队列中取出连接，读取数据</p>
</li>
<li>
<p><strong>全连接队列满了以后，默认会丢弃连接，可以把tcp_abort_on_overflow设置为1，系统会给client发送rst包，直接断开连接，不过一般不建议，因为即使连接被丢弃了，client已经进入Establish状态，会不停重发包，如果server全连接队列有空位了，可以直接进入Establish</strong></p>
</li>
</ul>
</li>
<li>
<p>SYN包何时被丢弃</p>
<ul>
<li>
<p>半连接队列满了</p>
</li>
<li>
<p>老的linux有tcp_tw_recycle参数，表示快速回收Timewait的连接，但是开启后，会有PAWS机制，已IP为单位，校验tcp option里的时间戳，直接丢弃过时的包，如果server处于NAT网络，所有client的连接到达后都是同一个IP，如果A断开连接后，收到B的SYN，且B的时钟是过去，就会直接丢弃B的SYN包</p>
</li>
</ul>
</li>
<li>
<p>开启syncookies可以在半连接队列满了以后，成功建立连接</p>
</li>
</ul>
<h1 id="kafka"><a class="markdownIt-Anchor" href="#kafka"></a> kafka</h1>
<h2 id="消息丢失"><a class="markdownIt-Anchor" href="#消息丢失"></a> 消息丢失</h2>
<ul>
<li>
<p>生产端：</p>
<ul>
<li>
<p>异步发送消息，broker每收到或者broker保存前down</p>
</li>
<li>
<p>leader broker 宕机，选举出的新leader落后太多</p>
</li>
</ul>
</li>
<li>
<p>消费端：</p>
<ul>
<li>
<p>手动commit，先commit后处理，如果commit后立即down了，会丢消息</p>
</li>
<li>
<p>自动commit</p>
<ul>
<li>
<p>消息处理慢，处理完前commit了，但是处理失败了</p>
</li>
<li>
<p>在commit前由于消费处理太慢等原因导致rebalance</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="重复消费"><a class="markdownIt-Anchor" href="#重复消费"></a> 重复消费</h2>
<ul>
<li>
<p>手动commit时，先处理后commit，如果commit前down了，重启后会重复消费</p>
</li>
<li>
<p>自动commit时，如果在commit前down了，重启后会重复消费</p>
</li>
</ul>
<h2 id="分区leader选举策略"><a class="markdownIt-Anchor" href="#分区leader选举策略"></a> 分区leader选举策略</h2>
<ul>
<li>
<p>OfflinePartition：每当有新Partition上线，就执行选举</p>
</li>
<li>
<p>ReassignPartition：手动运行kafka-reassign-partitions命令，或者调用Admin的alterPartitionReassignments方法来执行分区副本重分配，可能触发选举</p>
</li>
<li>
<p>PreferredPartition：手动运行kafka-preferred-replica-election 命令，或自动触发了 Preferred Leader 选举时</p>
</li>
<li>
<p>ControlledShutdownPartition：当Broker正常关闭时，该Broker上的所有Leader都得下线，因此需要执行重新选举</p>
</li>
</ul>
<h2 id="ack机制"><a class="markdownIt-Anchor" href="#ack机制"></a> ACK机制</h2>
<ol>
<li>
<p>0: 生产者不等待broker ack</p>
</li>
<li>
<p>1：生产者等待leader broker ack</p>
</li>
<li>
<p>-1：生产者等待所有broker ack</p>
</li>
</ol>
<h1 id="go"><a class="markdownIt-Anchor" href="#go"></a> GO</h1>
<!-- flag of hidden posts --></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="posts/2211132a/">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-06-23 23:06:06" itemprop="dateModified" datetime="2024-06-23T23:06:06+08:00">2024-06-23</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img loading="lazy" data-src="/assets/wechatpay.png" alt="Linsan Zhu 微信支付"/><p>微信支付</p></div><div><img loading="lazy" data-src="/assets/alipay.png" alt="Linsan Zhu 支付宝"/><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Linsan Zhu<i class="ic i-at"><em>@</em></i>烂笔头</li><li class="link"><strong>本文链接：</strong><a href="https://linsanzhu.github.io/posts/2211132a/" title="面试知识总结">https://linsanzhu.github.io/posts/2211132a/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis"><span class="toc-number">1.</span> <span class="toc-text"> Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text"> 数据类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text"> 数据结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text"> 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aof%E8%AE%B0%E5%BD%95%E5%86%99%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.1.</span> <span class="toc-text"> AOF：记录写操作命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rdb%E5%86%85%E5%AD%98%E5%BF%AB%E7%85%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text"> RDB：内存快照</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-number">1.4.</span> <span class="toc-text"> 过期策略：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5"><span class="toc-number">1.5.</span> <span class="toc-text"> 淘汰策略：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.6.</span> <span class="toc-text"> 高可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.7.</span> <span class="toc-text"> 数据一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text"> 应用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.</span> <span class="toc-text"> 系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text"> 进程调度算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A1%B5%E9%9D%A2%E7%BD%AE%E6%8D%A2"><span class="toc-number">2.2.</span> <span class="toc-text"> 内存页面置换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">2.3.</span> <span class="toc-text"> 锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%BB%E9%94%81"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 死锁：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.</span> <span class="toc-text"> 进程通信方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#io%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.5.</span> <span class="toc-text"> IO类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%B6%E6%8B%B7%E8%B4%9D"><span class="toc-number">2.6.</span> <span class="toc-text"> 零拷贝</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql"><span class="toc-number">3.</span> <span class="toc-text"> MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text"> 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 特性：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 隔离级别：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvcc"><span class="toc-number">3.1.3.</span> <span class="toc-text"> MVCC:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81-2"><span class="toc-number">3.2.</span> <span class="toc-text"> 锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8"><span class="toc-number">3.3.</span> <span class="toc-text"> 存储</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%8C%E7%BB%93%E6%9E%84"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 行结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%A1%A8%E6%95%B0%E9%87%8F%E9%99%90%E5%88%B6%E8%AE%A1%E7%AE%97"><span class="toc-number">3.3.2.</span> <span class="toc-text"> 单表数量限制计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">3.4.</span> <span class="toc-text"> 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">3.4.1.</span> <span class="toc-text"> 分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="toc-number">3.4.2.</span> <span class="toc-text"> 索引失效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">3.5.</span> <span class="toc-text"> 分库分表</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C"><span class="toc-number">4.</span> <span class="toc-text"> 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#tcpip%E6%A8%A1%E5%9E%8B"><span class="toc-number">4.1.</span> <span class="toc-text"> Tcp&#x2F;IP模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BA%94%E7%94%A8%E5%B1%82"><span class="toc-number">4.1.1.</span> <span class="toc-text"> 1. 应用层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http"><span class="toc-number">4.1.1.1.</span> <span class="toc-text"> HTTP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#http-11"><span class="toc-number">4.1.1.1.1.</span> <span class="toc-text"> HTTP 1.1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http-2"><span class="toc-number">4.1.1.1.2.</span> <span class="toc-text"> HTTP 2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#http-3"><span class="toc-number">4.1.1.1.3.</span> <span class="toc-text"> HTTP 3</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#https"><span class="toc-number">4.1.1.2.</span> <span class="toc-text"> HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">4.1.1.2.1.</span> <span class="toc-text"> 建立连接过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BC%A0%E8%BE%93%E5%B1%82"><span class="toc-number">4.1.2.</span> <span class="toc-text"> 2. 传输层</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tcp"><span class="toc-number">4.1.2.1.</span> <span class="toc-text"> TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-number">4.1.2.1.1.</span> <span class="toc-text"> 三次握手</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="toc-number">4.1.2.1.2.</span> <span class="toc-text"> 四次挥手</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6"><span class="toc-number">4.1.2.1.3.</span> <span class="toc-text"> 重传机制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E9%87%8D%E4%BC%A0"><span class="toc-number">4.1.2.1.3.1.</span> <span class="toc-text"> 超时重传</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0"><span class="toc-number">4.1.2.1.3.2.</span> <span class="toc-text"> 快速重传</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#sack"><span class="toc-number">4.1.2.1.3.3.</span> <span class="toc-text"> SACK</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">4.1.2.1.4.</span> <span class="toc-text"> 流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3"><span class="toc-number">4.1.2.1.4.1.</span> <span class="toc-text"> 滑动窗口</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="toc-number">4.1.2.1.5.</span> <span class="toc-text"> 拥塞控制</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%85%A2%E5%90%AF%E5%8A%A8"><span class="toc-number">4.1.2.1.5.1.</span> <span class="toc-text"> 慢启动</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D"><span class="toc-number">4.1.2.1.5.2.</span> <span class="toc-text"> 拥塞避免</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8B%A5%E5%A1%9E%E5%8F%91%E7%94%9F"><span class="toc-number">4.1.2.1.5.3.</span> <span class="toc-text"> 拥塞发生</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D"><span class="toc-number">4.1.2.1.5.4.</span> <span class="toc-text"> 快速恢复</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%8A%E8%BF%9E%E6%8E%A5-%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97"><span class="toc-number">4.1.2.1.6.</span> <span class="toc-text"> 半连接、全连接队列</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#kafka"><span class="toc-number">5.</span> <span class="toc-text"> kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E4%B8%A2%E5%A4%B1"><span class="toc-number">5.1.</span> <span class="toc-text"> 消息丢失</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="toc-number">5.2.</span> <span class="toc-text"> 重复消费</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%8C%BAleader%E9%80%89%E4%B8%BE%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.</span> <span class="toc-text"> 分区leader选举策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ack%E6%9C%BA%E5%88%B6"><span class="toc-number">5.4.</span> <span class="toc-text"> ACK机制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#go"><span class="toc-number">6.</span> <span class="toc-text"> GO</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Linsan Zhu" src="/assets/avatar.png"/><p class="name" itemprop="name">Linsan Zhu</p><div class="description" itemprop="description">LinsanZhu's Blog</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">4</span><span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">3</span><span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">5</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/linsanzhu" class="item github" title="https:&#x2F;&#x2F;github.com&#x2F;linsanzhu"><i class="ic i-github"></i></a><a href="mailto:bin.zaq@foxmail.com" class="item email" title="mailto:bin.zaq@foxmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-archive"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/posts/57784073/" rel="section"><i class="ic i-link-alt"></i>私密</a></li></ul></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/golang/" title="分类于Golang">Golang</a></div><span><a href="/posts/12887/">Golang深拷贝</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/golang/" title="分类于Golang">Golang</a></div><span><a href="/posts/32785/">Golang插件</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-sre/" title="分类于Linux运维">Linux运维</a></div><span><a href="/posts/48230/">Linux常用命令</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/linux-sre/" title="分类于Linux运维">Linux运维</a></div><span><a href="/posts/27368/">Linux系统服务</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2021 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Linsan Zhu @ Linsan Zhu's Blog</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">38k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">35 分钟</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> & Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
    ispost: true,
        path: `posts/2211132a/`,
        favicon: {
        show: `不负韶华`,
        hide: `以梦为马！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: true,
    katex: true,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.2.4/pace.min.js" async></script><script src="/js/siteInit.js?v=0.4.2" type="module" fetchpriority="high" defer></script></body></html>